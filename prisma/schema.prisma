// Fox & Sons Southsea - SaaS Database Schema
// Supabase (PostgreSQL) via Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ─────────────────────────────────────────────
// Auth & Users
// ─────────────────────────────────────────────

model User {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique
  name      String
  avatarUrl String?  @map("avatar_url")
  phone     String?
  role      UserRole @default(AGENT)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  properties    Property[]
  leads         Lead[]         @relation("AssignedAgent")
  activities    Activity[]
  socialPosts   SocialPost[]
  leadNotes     LeadNote[]
  agentMetrics  AgentMetric[]

  @@map("users")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  AGENT
  VIEWER
}

// ─────────────────────────────────────────────
// Properties
// ─────────────────────────────────────────────

model Property {
  id               String         @id @default(uuid()) @db.Uuid
  slug             String         @unique
  title            String
  description      String         @db.Text
  price            Decimal        @db.Decimal(12, 2)
  priceQualifier   PriceQualifier @default(GUIDE_PRICE) @map("price_qualifier")
  propertyType     PropertyType   @map("property_type")
  listingType      ListingType    @map("listing_type")
  status           PropertyStatus @default(AVAILABLE)
  bedrooms         Int
  bathrooms        Int
  receptions       Int            @default(1)
  squareFt         Int?           @map("square_ft")
  address          String
  postcode         String
  area             String         @default("Southsea")
  city             String         @default("Portsmouth")
  latitude         Float?
  longitude        Float?
  epcRating        String?        @map("epc_rating")
  councilTaxBand   String?        @map("council_tax_band")
  tenure           Tenure?
  keyFeatures      String[]       @map("key_features")
  floorplanUrl     String?        @map("floorplan_url")
  virtualTourUrl   String?        @map("virtual_tour_url")
  featuredImage    String?        @map("featured_image")
  isFeatured       Boolean        @default(false) @map("is_featured")
  publishedAt      DateTime?      @map("published_at")
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")

  // Relations
  agent            User           @relation(fields: [agentId], references: [id])
  agentId          String         @map("agent_id") @db.Uuid
  images           PropertyImage[]
  leads            Lead[]
  viewings         Viewing[]
  scoutMatches     ScoutMatch[]

  @@index([postcode])
  @@index([area])
  @@index([status])
  @@index([propertyType, listingType])
  @@index([price])
  @@map("properties")
}

model PropertyImage {
  id         String   @id @default(uuid()) @db.Uuid
  url        String
  alt        String?
  sortOrder  Int      @default(0) @map("sort_order")
  isPrimary  Boolean  @default(false) @map("is_primary")
  propertyId String   @map("property_id") @db.Uuid
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("property_images")
}

enum PropertyType {
  DETACHED
  SEMI_DETACHED
  TERRACED
  FLAT
  MAISONETTE
  BUNGALOW
  TOWNHOUSE
  COTTAGE
  PENTHOUSE
  STUDIO
  LAND
  COMMERCIAL
}

enum ListingType {
  SALE
  RENT
}

enum PropertyStatus {
  AVAILABLE
  UNDER_OFFER
  SOLD_STC
  SOLD
  LET_AGREED
  LET
  WITHDRAWN
  DRAFT
}

enum PriceQualifier {
  ASKING_PRICE
  GUIDE_PRICE
  OFFERS_OVER
  OFFERS_IN_REGION
  FIXED_PRICE
  POA
  PCM
}

enum Tenure {
  FREEHOLD
  LEASEHOLD
  SHARE_OF_FREEHOLD
  COMMONHOLD
}

// ─────────────────────────────────────────────
// Leads & CRM
// ─────────────────────────────────────────────

model Lead {
  id            String      @id @default(uuid()) @db.Uuid
  name          String
  email         String
  phone         String?
  source        LeadSource  @default(WEBSITE)
  status        LeadStatus  @default(NEW)
  priority      LeadPriority @default(MEDIUM)
  budget        Decimal?    @db.Decimal(12, 2)
  message       String?     @db.Text
  preferredArea String?     @map("preferred_area")
  minBedrooms   Int?        @map("min_bedrooms")
  propertyTypes PropertyType[]  @map("property_types")
  score         Int         @default(0) // AI-calculated lead score 0-100
  lastContactAt DateTime?   @map("last_contact_at")
  convertedAt   DateTime?   @map("converted_at")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  // Relations
  assignedAgent User?       @relation("AssignedAgent", fields: [agentId], references: [id])
  agentId       String?     @map("agent_id") @db.Uuid
  property      Property?   @relation(fields: [propertyId], references: [id])
  propertyId    String?     @map("property_id") @db.Uuid
  notes         LeadNote[]
  viewings      Viewing[]

  @@index([status])
  @@index([source])
  @@index([agentId])
  @@index([score])
  @@map("leads")
}

model LeadNote {
  id        String   @id @default(uuid()) @db.Uuid
  content   String   @db.Text
  leadId    String   @map("lead_id") @db.Uuid
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  authorId  String   @map("author_id") @db.Uuid
  author    User     @relation(fields: [authorId], references: [id])
  createdAt DateTime @default(now()) @map("created_at")

  @@map("lead_notes")
}

model Viewing {
  id         String        @id @default(uuid()) @db.Uuid
  date       DateTime
  status     ViewingStatus @default(SCHEDULED)
  feedback   String?       @db.Text
  leadId     String        @map("lead_id") @db.Uuid
  lead       Lead          @relation(fields: [leadId], references: [id], onDelete: Cascade)
  propertyId String        @map("property_id") @db.Uuid
  property   Property      @relation(fields: [propertyId], references: [id])
  createdAt  DateTime      @default(now()) @map("created_at")
  updatedAt  DateTime      @updatedAt @map("updated_at")

  @@map("viewings")
}

enum LeadSource {
  WEBSITE
  AI_SCOUT
  RIGHTMOVE
  ZOOPLA
  ONTHEMARKET
  REFERRAL
  WALK_IN
  PHONE
  SOCIAL_MEDIA
  EMAIL_CAMPAIGN
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  VIEWING_BOOKED
  OFFER_MADE
  NEGOTIATING
  CONVERTED
  LOST
  NURTURING
}

enum LeadPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ViewingStatus {
  SCHEDULED
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

// ─────────────────────────────────────────────
// AI Agents
// ─────────────────────────────────────────────

model ScoutMatch {
  id             String       @id @default(uuid()) @db.Uuid
  sourceUrl      String?      @map("source_url")
  sourcePlatform String?      @map("source_platform")
  matchData      Json         @map("match_data")
  matchScore     Float        @map("match_score")
  status         ScoutStatus  @default(PENDING)
  propertyId     String?      @map("property_id") @db.Uuid
  property       Property?    @relation(fields: [propertyId], references: [id])
  processedAt    DateTime?    @map("processed_at")
  createdAt      DateTime     @default(now()) @map("created_at")

  @@index([status])
  @@index([matchScore])
  @@map("scout_matches")
}

model SocialPost {
  id          String          @id @default(uuid()) @db.Uuid
  platform    SocialPlatform
  content     String          @db.Text
  imageUrl    String?         @map("image_url")
  imagePrompt String?         @map("image_prompt") @db.Text
  hashtags    String[]
  status      PostStatus      @default(DRAFT)
  scheduledAt DateTime?       @map("scheduled_at")
  publishedAt DateTime?       @map("published_at")
  engagement  Json?           // { likes, shares, comments, reach }
  createdBy   User            @relation(fields: [createdById], references: [id])
  createdById String          @map("created_by_id") @db.Uuid
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  @@index([platform, status])
  @@map("social_posts")
}

enum ScoutStatus {
  PENDING
  REVIEWED
  MATCHED
  DISMISSED
}

enum SocialPlatform {
  INSTAGRAM
  FACEBOOK
  TWITTER
  LINKEDIN
}

enum PostStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
  FAILED
}

// ─────────────────────────────────────────────
// Analytics & Activity
// ─────────────────────────────────────────────

model Activity {
  id          String       @id @default(uuid()) @db.Uuid
  type        ActivityType
  description String
  metadata    Json?
  userId      String?      @map("user_id") @db.Uuid
  user        User?        @relation(fields: [userId], references: [id])
  createdAt   DateTime     @default(now()) @map("created_at")

  @@index([type])
  @@index([userId])
  @@index([createdAt])
  @@map("activities")
}

model AgentMetric {
  id               String   @id @default(uuid()) @db.Uuid
  date             DateTime @db.Date
  userId           String   @map("user_id") @db.Uuid
  user             User     @relation(fields: [userId], references: [id])
  leadsGenerated   Int      @default(0) @map("leads_generated")
  viewingsConducted Int     @default(0) @map("viewings_conducted")
  offersMade       Int      @default(0) @map("offers_made")
  dealsClosed      Int      @default(0) @map("deals_closed")
  revenue          Decimal  @default(0) @db.Decimal(12, 2)
  createdAt        DateTime @default(now()) @map("created_at")

  @@unique([userId, date])
  @@index([date])
  @@map("agent_metrics")
}

model PageView {
  id        String   @id @default(uuid()) @db.Uuid
  path      String
  referrer  String?
  userAgent String?  @map("user_agent")
  sessionId String?  @map("session_id")
  duration  Int?     // seconds on page
  createdAt DateTime @default(now()) @map("created_at")

  @@index([path])
  @@index([createdAt])
  @@map("page_views")
}

enum ActivityType {
  LEAD_CREATED
  LEAD_UPDATED
  LEAD_CONVERTED
  PROPERTY_LISTED
  PROPERTY_UPDATED
  VIEWING_SCHEDULED
  OFFER_RECEIVED
  DEAL_CLOSED
  AGENT_LOGIN
  SCOUT_RUN
  SOCIAL_POSTED
}
